<!doctype html>
<html class="no-js" lang="en" data-content_root="../../">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark"><link rel="index" title="Index" href="../../genindex.html"><link rel="search" title="Search" href="../../search.html">
        <link rel="prefetch" href="../../_static/img/logo-light.svg" as="image">
        <link rel="prefetch" href="../../_static/img/logo-dark.svg" as="image">

    <link rel="shortcut icon" href="../../_static/favicon.ico"><!-- Generated with Sphinx 8.2.3 and Furo 2025.09.25 -->
        <title>stable_worldmodel.spaces - stable-worldmodel Documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=8f2a1f02" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=580074bf" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=8dab3a3b" />
    <link rel="stylesheet" type="text/css" href="../../_static/css/custom.css?v=33d9fa98" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/fontawesome.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/solid.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/brands.min.css" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  --color-brand-primary: #202123;
  --color-brand-content: #296cde;
  --color-inline-code-background: #f8f8f8;
  --color-brand-visited: #2757dd;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #272822;
  --color-code-foreground: #f8f8f2;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #272822;
  --color-code-foreground: #f8f8f2;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">stable-worldmodel
Documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon no-toc" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  <div class="sidebar-logo-container">
    <img class="sidebar-logo only-light" src="../../_static/img/logo-light.svg" alt="Light Logo"/>
    <img class="sidebar-logo only-dark" src="../../_static/img/logo-dark.svg" alt="Dark Logo"/>
  </div>
  
  <span class="sidebar-brand-text">stable-worldmodel
Documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/randall-lab/stable-worldmodel">Github</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/randall-lab/stable-worldmodel/tree/main/docs">Contribute to the Docs</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon no-toc" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <h1>Source code for stable_worldmodel.spaces</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Extended Gymnasium spaces with state tracking and constraint support.</span>

<span class="sd">This module provides custom Gymnasium space classes that extend the standard</span>
<span class="sd">Gymnasium spaces with additional functionality for managing environment variations</span>
<span class="sd">and initial conditions. Unlike traditional Gymnasium spaces which primarily define</span>
<span class="sd">boundaries for action and observation spaces in RL environments, these extended</span>
<span class="sd">spaces are designed to:</span>

<span class="sd">1. **Track current state**: Each space maintains a current value in addition to</span>
<span class="sd">   defining valid boundaries.</span>
<span class="sd">2. **Support initial values**: Spaces can be initialized with specific values that</span>
<span class="sd">   represent the starting state for environment episodes.</span>
<span class="sd">3. **Enable constraint functions**: Optional user-defined predicates for rejection</span>
<span class="sd">   sampling ensure sampled values satisfy custom conditions.</span>
<span class="sd">4. **Provide ordered sampling**: Dict spaces support explicit sampling order for</span>
<span class="sd">   handling dependencies between variables.</span>

<span class="sd">These spaces are particularly useful for defining procedurally generated environments</span>
<span class="sd">or environments with configurable parameters, where each space represents a variable</span>
<span class="sd">aspect of the environment that can be sampled, reset, and validated.</span>

<span class="sd">Classes:</span>
<span class="sd">    Discrete: Extended discrete space with state tracking and constraint support.</span>
<span class="sd">        Supports integer values in range [0, n) with optional constraint function.</span>

<span class="sd">    MultiDiscrete: Extended multi-discrete space with state tracking.</span>
<span class="sd">        Represents multiple discrete values with different ranges (nvec).</span>

<span class="sd">    Box: Extended continuous box space with constraint support.</span>
<span class="sd">        Represents bounded continuous values with configurable shape and dtype.</span>

<span class="sd">    RGBBox: Specialized box space for RGB image data.</span>
<span class="sd">        Automatically constrains to 3-channel uint8 images with values [0, 255].</span>

<span class="sd">    Dict: Extended dictionary space with ordered sampling and nesting support.</span>
<span class="sd">        Composes multiple spaces with dependencies and hierarchical structure.</span>

<span class="sd">Typical usage example:</span>

<span class="sd">    Create a constrained discrete space that only samples even numbers::</span>

<span class="sd">        from stable_worldmodel import spaces</span>

<span class="sd">        even_space = spaces.Discrete(</span>
<span class="sd">            n=10, init_value=0, constrain_fn=lambda x: x % 2 == 0</span>
<span class="sd">        )</span>

<span class="sd">        # Sample valid even numbers</span>
<span class="sd">        value = even_space.sample()</span>
<span class="sd">        print(f&quot;Sampled: {value}, Current: {even_space.value}&quot;)</span>

<span class="sd">        # Reset to initial value</span>
<span class="sd">        even_space.reset()</span>

<span class="sd">    Create a nested dictionary space with sampling order::</span>

<span class="sd">        from stable_worldmodel import spaces</span>
<span class="sd">        import numpy as np</span>

<span class="sd">        env_config = spaces.Dict(</span>
<span class="sd">            {</span>
<span class="sd">                &quot;difficulty&quot;: spaces.Discrete(n=3, init_value=0),</span>
<span class="sd">                &quot;agent_pos&quot;: spaces.Box(</span>
<span class="sd">                    low=np.array([0, 0]),</span>
<span class="sd">                    high=np.array([10, 10]),</span>
<span class="sd">                    init_value=np.array([5, 5]),</span>
<span class="sd">                ),</span>
<span class="sd">                &quot;goal_pos&quot;: spaces.Box(</span>
<span class="sd">                    low=np.array([0, 0]),</span>
<span class="sd">                    high=np.array([10, 10]),</span>
<span class="sd">                    init_value=np.array([9, 9]),</span>
<span class="sd">                ),</span>
<span class="sd">            },</span>
<span class="sd">            sampling_order=[&quot;difficulty&quot;, &quot;goal_pos&quot;, &quot;agent_pos&quot;],</span>
<span class="sd">        )</span>

<span class="sd">        # Sample respects the specified order</span>
<span class="sd">        config = env_config.sample()</span>

<span class="sd">        # Access nested values</span>
<span class="sd">        print(f&quot;Difficulty: {config[&#39;difficulty&#39;]}&quot;)</span>

<span class="sd">    Create an RGB image space::</span>

<span class="sd">        from stable_worldmodel import spaces</span>
<span class="sd">        import numpy as np</span>

<span class="sd">        image_space = spaces.RGBBox(</span>
<span class="sd">            shape=(64, 64, 3), init_value=np.zeros((64, 64, 3), dtype=np.uint8)</span>
<span class="sd">        )</span>

<span class="sd">        # Sample random RGB image</span>
<span class="sd">        img = image_space.sample()</span>

<span class="sd">Attributes:</span>
<span class="sd">    This module does not define any module-level variables.</span>

<span class="sd">Note:</span>
<span class="sd">    These spaces extend ``gymnasium.spaces`` classes and maintain API compatibility</span>
<span class="sd">    while adding state management features. The ``sample()`` method performs</span>
<span class="sd">    rejection sampling when a ``constrain_fn`` is provided, which may impact</span>
<span class="sd">    performance if constraints are difficult to satisfy.</span>

<span class="sd">    All spaces support the following additional parameters:</span>
<span class="sd">        * ``init_value``: Initial value for the space (returned by reset)</span>
<span class="sd">        * ``constrain_fn``: Optional callable returning bool for validation</span>
<span class="sd">        * ``max_tries``: Maximum rejection sampling attempts (default: 1000)</span>
<span class="sd">        * ``warn_after_s``: Warning threshold for slow sampling (default: 5.0s)</span>

<span class="sd">    **Important**: When accessing values in constraint functions for nested Dict</span>
<span class="sd">    spaces, prefer using ``space.value[&#39;key&#39;][&#39;key2&#39;]`` over</span>
<span class="sd">    ``space[&#39;key&#39;][&#39;key2&#39;].value``. The ``.value`` property recursively</span>
<span class="sd">    constructs the complete value dictionary top-down with all current information,</span>
<span class="sd">    while direct space access only retrieves the individual subspace&#39;s value.</span>

<span class="sd">See Also:</span>
<span class="sd">    stable_worldmodel.world: World class that composes these spaces</span>
<span class="sd">    stable_worldmodel.envs: Environment implementations using these spaces</span>
<span class="sd">    gymnasium.spaces: Base Gymnasium spaces documentation</span>

<span class="sd">Todo:</span>
<span class="sd">    * Achieve full test coverage for the module</span>
<span class="sd">    * Implement automatic type casting for init_value to match space dtype</span>
<span class="sd">    * Add serialization/deserialization support for saving space states</span>
<span class="sd">    * Optimize constraint checking for large spaces (e.g. MultiDiscrete)</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">gymnasium</span><span class="w"> </span><span class="kn">import</span> <span class="n">spaces</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">loguru</span><span class="w"> </span><span class="kn">import</span> <span class="n">logger</span> <span class="k">as</span> <span class="n">logging</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">stable_worldmodel</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">swm</span>


<div class="viewcode-block" id="Discrete">
<a class="viewcode-back" href="../../stable_worldmodel.html#stable_worldmodel.spaces.Discrete">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Discrete</span><span class="p">(</span><span class="n">spaces</span><span class="o">.</span><span class="n">Discrete</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extended discrete space with state tracking and constraint support.</span>

<span class="sd">    This class extends ``gymnasium.spaces.Discrete`` to add state management</span>
<span class="sd">    and optional constraint validation. Unlike the standard discrete space,</span>
<span class="sd">    this version maintains a current value and supports rejection sampling</span>
<span class="sd">    via a custom constraint function.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        init_value (int): The initial value for the space.</span>
<span class="sd">        value (int): The current value of the space.</span>
<span class="sd">        constrain_fn (callable): Optional function that returns True if a</span>
<span class="sd">            value satisfies custom constraints.</span>

<span class="sd">    Example:</span>
<span class="sd">        Create a discrete space that only accepts even numbers::</span>

<span class="sd">            space = Discrete(n=10, init_value=0, constrain_fn=lambda x: x % 2 == 0)</span>
<span class="sd">            value = space.sample()  # Samples even number and updates space.value</span>
<span class="sd">            space.reset()  # Resets space.value back to 0 (init_value)</span>

<span class="sd">    Note:</span>
<span class="sd">        The ``sample()`` method uses rejection sampling when a constraint</span>
<span class="sd">        function is provided, which may impact performance for difficult</span>
<span class="sd">        constraints.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Discrete.__init__">
<a class="viewcode-back" href="../../stable_worldmodel.html#stable_worldmodel.spaces.Discrete.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">init_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">constrain_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a Discrete space with state tracking.</span>

<span class="sd">        Args:</span>
<span class="sd">            *args: Positional arguments passed to gymnasium.spaces.Discrete.</span>
<span class="sd">            init_value (int, optional): Initial value for the space. Defaults to None.</span>
<span class="sd">            constrain_fn (callable, optional): Function that takes an int and returns</span>
<span class="sd">                True if the value satisfies custom constraints. Defaults to None.</span>
<span class="sd">            **kwargs: Keyword arguments passed to gymnasium.spaces.Discrete.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_value</span> <span class="o">=</span> <span class="n">init_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constrain_fn</span> <span class="o">=</span> <span class="n">constrain_fn</span> <span class="ow">or</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">init_value</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">init_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;int: The initial value of the space, returned by reset().&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_value</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;int: The current value of the space.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span>

<div class="viewcode-block" id="Discrete.reset">
<a class="viewcode-back" href="../../stable_worldmodel.html#stable_worldmodel.spaces.Discrete.reset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset the space value to its initial value.</span>

<span class="sd">        Sets the current value back to the init_value specified during</span>
<span class="sd">        initialization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_value</span></div>


<div class="viewcode-block" id="Discrete.contains">
<a class="viewcode-back" href="../../stable_worldmodel.html#stable_worldmodel.spaces.Discrete.contains">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">contains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if value is valid and satisfies constraints.</span>

<span class="sd">        Args:</span>
<span class="sd">            x (int): The value to check.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if x is within bounds and satisfies the constraint</span>
<span class="sd">                function, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">constrain_fn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>


<div class="viewcode-block" id="Discrete.check">
<a class="viewcode-back" href="../../stable_worldmodel.html#stable_worldmodel.spaces.Discrete.check">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate the current space value.</span>

<span class="sd">        Checks if the current value is within the space bounds and satisfies</span>
<span class="sd">        the constraint function. Logs a warning if the constraint fails.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the current value is valid, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">constrain_fn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Discrete: value </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> does not satisfy constrain_fn&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="Discrete.sample">
<a class="viewcode-back" href="../../stable_worldmodel.html#stable_worldmodel.spaces.Discrete.sample">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">max_tries</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">warn_after_s</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">set_value</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sample a random value using rejection sampling for constraints.</span>

<span class="sd">        Repeatedly samples values until one satisfies the constraint function</span>
<span class="sd">        or max_tries is reached. Optionally updates the space&#39;s current value.</span>

<span class="sd">        Args:</span>
<span class="sd">            *args: Positional arguments passed to gymnasium.spaces.Discrete.sample().</span>
<span class="sd">            max_tries (int, optional): Maximum number of sampling attempts before</span>
<span class="sd">                raising an error. Defaults to 1000.</span>
<span class="sd">            warn_after_s (float, optional): Time threshold in seconds after which</span>
<span class="sd">                to log a warning about slow sampling. Set to None to disable.</span>
<span class="sd">                Defaults to 5.0.</span>
<span class="sd">            set_value (bool, optional): Whether to update the space&#39;s current</span>
<span class="sd">                value with the sampled value. Defaults to True.</span>
<span class="sd">            **kwargs: Keyword arguments passed to gymnasium.spaces.Discrete.sample().</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: A sampled value that satisfies the constraint function.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If no valid sample is found after max_tries attempts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_tries</span><span class="p">):</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">sample</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">set_value</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">sample</span>
                <span class="k">return</span> <span class="n">sample</span>
            <span class="k">if</span> <span class="n">warn_after_s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">warn_after_s</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;rejection sampling: rejection sampling is taking a while...&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rejection sampling: predicate not satisfied after </span><span class="si">{</span><span class="n">max_tries</span><span class="si">}</span><span class="s2"> draws&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="MultiDiscrete">
<a class="viewcode-back" href="../../stable_worldmodel.html#stable_worldmodel.spaces.MultiDiscrete">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">MultiDiscrete</span><span class="p">(</span><span class="n">spaces</span><span class="o">.</span><span class="n">MultiDiscrete</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extended multi-discrete space with state tracking and constraint support.</span>

<span class="sd">    This class extends ``gymnasium.spaces.MultiDiscrete`` to add state</span>
<span class="sd">    management and optional constraint validation. It represents multiple</span>
<span class="sd">    discrete variables with potentially different ranges (nvec), where each</span>
<span class="sd">    variable maintains its own value and can be constrained.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        init_value (np.ndarray): The initial values for all discrete variables.</span>
<span class="sd">        value (np.ndarray): The current values of all discrete variables.</span>
<span class="sd">        constrain_fn (callable): Optional function that returns True if the</span>
<span class="sd">            entire value array satisfies custom constraints.</span>

<span class="sd">    Example:</span>
<span class="sd">        Create a multi-discrete space for game difficulty settings::</span>

<span class="sd">            import numpy as np</span>

<span class="sd">            space = MultiDiscrete(</span>
<span class="sd">                nvec=[5, 3, 10],  # [enemy_count, speed_level, spawn_rate]</span>
<span class="sd">                init_value=np.array([2, 1, 5]),</span>
<span class="sd">            )</span>
<span class="sd">            settings = space.sample()  # Random difficulty configuration</span>
<span class="sd">            space.reset()  # Resets to [2, 1, 5] (medium difficulty)</span>

<span class="sd">    Note:</span>
<span class="sd">        Constraints are applied to the entire array, not individual elements.</span>
<span class="sd">        Use a constraint function that validates the complete state.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="MultiDiscrete.__init__">
<a class="viewcode-back" href="../../stable_worldmodel.html#stable_worldmodel.spaces.MultiDiscrete.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">init_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">constrain_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a MultiDiscrete space with state tracking.</span>

<span class="sd">        Args:</span>
<span class="sd">            *args: Positional arguments passed to gymnasium.spaces.MultiDiscrete.</span>
<span class="sd">            init_value (np.ndarray, optional): Initial values for the space.</span>
<span class="sd">                Must match the shape defined by nvec. Defaults to None.</span>
<span class="sd">            constrain_fn (callable, optional): Function that takes a numpy array</span>
<span class="sd">                and returns True if the values satisfy custom constraints.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            **kwargs: Keyword arguments passed to gymnasium.spaces.MultiDiscrete.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_value</span> <span class="o">=</span> <span class="n">init_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constrain_fn</span> <span class="o">=</span> <span class="n">constrain_fn</span> <span class="ow">or</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">init_value</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">init_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;np.ndarray: The initial values of the space, returned by reset().&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_value</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;np.ndarray: The current values of the space.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span>

<div class="viewcode-block" id="MultiDiscrete.reset">
<a class="viewcode-back" href="../../stable_worldmodel.html#stable_worldmodel.spaces.MultiDiscrete.reset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset the space values to their initial values.</span>

<span class="sd">        Sets the current values back to the init_value specified during</span>
<span class="sd">        initialization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_value</span></div>


<div class="viewcode-block" id="MultiDiscrete.contains">
<a class="viewcode-back" href="../../stable_worldmodel.html#stable_worldmodel.spaces.MultiDiscrete.contains">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">contains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if values are valid and satisfy constraints.</span>

<span class="sd">        Args:</span>
<span class="sd">            x (np.ndarray): The array of values to check.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if x is within bounds for all elements and satisfies</span>
<span class="sd">                the constraint function, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">constrain_fn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>


<div class="viewcode-block" id="MultiDiscrete.check">
<a class="viewcode-back" href="../../stable_worldmodel.html#stable_worldmodel.spaces.MultiDiscrete.check">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate the current space values.</span>

<span class="sd">        Checks if the current values are within the space bounds and satisfy</span>
<span class="sd">        the constraint function. Logs a warning if the constraint fails.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the current values are valid, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">constrain_fn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;MultiDiscrete: value </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> does not satisfy constrain_fn&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="MultiDiscrete.sample">
<a class="viewcode-back" href="../../stable_worldmodel.html#stable_worldmodel.spaces.MultiDiscrete.sample">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">max_tries</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">warn_after_s</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">set_value</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sample random values using rejection sampling for constraints.</span>

<span class="sd">        Repeatedly samples value arrays until one satisfies the constraint</span>
<span class="sd">        function or max_tries is reached. Optionally updates the space&#39;s</span>
<span class="sd">        current values.</span>

<span class="sd">        Args:</span>
<span class="sd">            *args: Positional arguments passed to gymnasium.spaces.MultiDiscrete.sample().</span>
<span class="sd">            max_tries (int, optional): Maximum number of sampling attempts before</span>
<span class="sd">                raising an error. Defaults to 1000.</span>
<span class="sd">            warn_after_s (float, optional): Time threshold in seconds after which</span>
<span class="sd">                to log a warning about slow sampling. Set to None to disable.</span>
<span class="sd">                Defaults to 5.0.</span>
<span class="sd">            set_value (bool, optional): Whether to update the space&#39;s current</span>
<span class="sd">                values with the sampled values. Defaults to True.</span>
<span class="sd">            **kwargs: Keyword arguments passed to gymnasium.spaces.MultiDiscrete.sample().</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: A sampled array that satisfies the constraint function.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If no valid sample is found after max_tries attempts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_tries</span><span class="p">):</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">sample</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">set_value</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">sample</span>
                <span class="k">return</span> <span class="n">sample</span>
            <span class="k">if</span> <span class="n">warn_after_s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">warn_after_s</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;rejection sampling: rejection sampling is taking a while...&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rejection sampling: predicate not satisfied after </span><span class="si">{</span><span class="n">max_tries</span><span class="si">}</span><span class="s2"> draws&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="Box">
<a class="viewcode-back" href="../../stable_worldmodel.html#stable_worldmodel.spaces.Box">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Box</span><span class="p">(</span><span class="n">spaces</span><span class="o">.</span><span class="n">Box</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extended continuous box space with state tracking and constraint support.</span>

<span class="sd">    This class extends ``gymnasium.spaces.Box`` to add state management and</span>
<span class="sd">    optional constraint validation. It represents bounded continuous values</span>
<span class="sd">    with configurable shape, dtype, and custom constraints.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        init_value (np.ndarray): The initial value for the space.</span>
<span class="sd">        value (np.ndarray): The current value of the space.</span>
<span class="sd">        constrain_fn (callable): Optional function that returns True if a</span>
<span class="sd">            value satisfies custom constraints beyond the box boundaries.</span>

<span class="sd">    Example:</span>
<span class="sd">        Create a 2D position space constrained to a circle::</span>

<span class="sd">            import numpy as np</span>


<span class="sd">            def in_circle(pos):</span>
<span class="sd">                return np.linalg.norm(pos) &lt;= 1.0</span>


<span class="sd">            space = Box(</span>
<span class="sd">                low=np.array([-1.0, -1.0]),</span>
<span class="sd">                high=np.array([1.0, 1.0]),</span>
<span class="sd">                init_value=np.array([0.0, 0.0]),</span>
<span class="sd">                constrain_fn=in_circle,</span>
<span class="sd">            )</span>
<span class="sd">            position = space.sample()  # Only samples within unit circle</span>

<span class="sd">    Note:</span>
<span class="sd">        The constraint function enables complex geometric or relational</span>
<span class="sd">        constraints beyond simple box boundaries.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Box.__init__">
<a class="viewcode-back" href="../../stable_worldmodel.html#stable_worldmodel.spaces.Box.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">init_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">constrain_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a Box space with state tracking.</span>

<span class="sd">        Args:</span>
<span class="sd">            *args: Positional arguments passed to gymnasium.spaces.Box.</span>
<span class="sd">            init_value (np.ndarray, optional): Initial value for the space.</span>
<span class="sd">                Must match the shape and dtype of the box. Defaults to None.</span>
<span class="sd">            constrain_fn (callable, optional): Function that takes a numpy array</span>
<span class="sd">                and returns True if the value satisfies custom constraints beyond</span>
<span class="sd">                the box boundaries. Defaults to None.</span>
<span class="sd">            **kwargs: Keyword arguments passed to gymnasium.spaces.Box.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constrain_fn</span> <span class="o">=</span> <span class="n">constrain_fn</span> <span class="ow">or</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_value</span> <span class="o">=</span> <span class="n">init_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">init_value</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">init_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;np.ndarray: The initial value of the space, returned by reset().&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_init_value</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;np.ndarray: The current value of the space.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span>

<div class="viewcode-block" id="Box.reset">
<a class="viewcode-back" href="../../stable_worldmodel.html#stable_worldmodel.spaces.Box.reset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset the space value to its initial value.</span>

<span class="sd">        Sets the current value back to the init_value specified during</span>
<span class="sd">        initialization.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_value</span></div>


<div class="viewcode-block" id="Box.contains">
<a class="viewcode-back" href="../../stable_worldmodel.html#stable_worldmodel.spaces.Box.contains">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">contains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if value is valid and satisfies constraints.</span>

<span class="sd">        Args:</span>
<span class="sd">            x (np.ndarray): The value to check.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if x is within box bounds and satisfies the constraint</span>
<span class="sd">                function, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">constrain_fn</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>


<div class="viewcode-block" id="Box.check">
<a class="viewcode-back" href="../../stable_worldmodel.html#stable_worldmodel.spaces.Box.check">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate the current space value.</span>

<span class="sd">        Checks if the current value is within the box bounds and satisfies</span>
<span class="sd">        the constraint function. Logs a warning if the constraint fails.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if the current value is valid, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">constrain_fn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">):</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Box: value </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> does not satisfy constrain_fn&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span></div>


<div class="viewcode-block" id="Box.sample">
<a class="viewcode-back" href="../../stable_worldmodel.html#stable_worldmodel.spaces.Box.sample">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">max_tries</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">warn_after_s</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">set_value</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sample a random value using rejection sampling for constraints.</span>

<span class="sd">        Repeatedly samples values until one satisfies the constraint function</span>
<span class="sd">        or max_tries is reached. Optionally updates the space&#39;s current value.</span>

<span class="sd">        Args:</span>
<span class="sd">            *args: Positional arguments passed to gymnasium.spaces.Box.sample().</span>
<span class="sd">            max_tries (int, optional): Maximum number of sampling attempts before</span>
<span class="sd">                raising an error. Defaults to 1000.</span>
<span class="sd">            warn_after_s (float, optional): Time threshold in seconds after which</span>
<span class="sd">                to log a warning about slow sampling. Set to None to disable.</span>
<span class="sd">                Defaults to 5.0.</span>
<span class="sd">            set_value (bool, optional): Whether to update the space&#39;s current</span>
<span class="sd">                value with the sampled value. Defaults to True.</span>
<span class="sd">            **kwargs: Keyword arguments passed to gymnasium.spaces.Box.sample().</span>

<span class="sd">        Returns:</span>
<span class="sd">            np.ndarray: A sampled array that satisfies the constraint function.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If no valid sample is found after max_tries attempts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_tries</span><span class="p">):</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">sample</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">set_value</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">sample</span>
                <span class="k">return</span> <span class="n">sample</span>
            <span class="k">if</span> <span class="n">warn_after_s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">warn_after_s</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;rejection sampling: rejection sampling is taking a while...&quot;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;rejection sampling: predicate not satisfied after </span><span class="si">{</span><span class="n">max_tries</span><span class="si">}</span><span class="s2"> draws&quot;</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="RGBBox">
<a class="viewcode-back" href="../../stable_worldmodel.html#stable_worldmodel.spaces.RGBBox">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RGBBox</span><span class="p">(</span><span class="n">Box</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Specialized box space for RGB image data with automatic constraints.</span>

<span class="sd">    This class extends ``Box`` to provide a convenient space for RGB images,</span>
<span class="sd">    automatically enforcing uint8 dtype and [0, 255] value ranges. It validates</span>
<span class="sd">    that the shape includes exactly 3 channels for RGB data.</span>

<span class="sd">    Args:</span>
<span class="sd">        shape (tuple): Shape of the image. Must include a dimension of size 3</span>
<span class="sd">            for the RGB channels. Common formats: (H, W, 3) or (3, H, W).</span>
<span class="sd">        init_value (np.ndarray, optional): Initial RGB image. Must match shape</span>
<span class="sd">            and be uint8 dtype.</span>
<span class="sd">        *args: Additional positional arguments passed to Box.</span>
<span class="sd">        **kwargs: Additional keyword arguments passed to Box.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        init_value (np.ndarray): The initial RGB image.</span>
<span class="sd">        value (np.ndarray): The current RGB image.</span>

<span class="sd">    Example:</span>
<span class="sd">        Create a space for 64x64 RGB images::</span>

<span class="sd">            import numpy as np</span>

<span class="sd">            space = RGBBox(</span>
<span class="sd">                shape=(64, 64, 3), init_value=np.zeros((64, 64, 3), dtype=np.uint8)</span>
<span class="sd">            )</span>
<span class="sd">            image = space.sample()  # Random RGB image</span>
<span class="sd">            space.reset()  # Returns to black image</span>

<span class="sd">    Raises:</span>
<span class="sd">        AssertionError: If shape does not contain a dimension of size 3.</span>

<span class="sd">    Note:</span>
<span class="sd">        This space is useful for vision-based environments where images</span>
<span class="sd">        need to be sampled or tracked as part of environment configuration.</span>
<span class="sd">        The low, high, and dtype parameters are automatically set and cannot</span>
<span class="sd">        be overridden.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,),</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">init_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">dim</span> <span class="o">==</span> <span class="mi">3</span> <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="n">shape</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;shape must have a channel of size 3&quot;</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">high</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span>
            <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>
            <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;uint8&quot;</span><span class="p">,</span>
            <span class="n">init_value</span><span class="o">=</span><span class="n">init_value</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="Dict">
<a class="viewcode-back" href="../../stable_worldmodel.html#stable_worldmodel.spaces.Dict">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Dict</span><span class="p">(</span><span class="n">spaces</span><span class="o">.</span><span class="n">Dict</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extended dictionary space with ordered sampling and nested support.</span>

<span class="sd">    This class extends ``gymnasium.spaces.Dict`` to add state management,</span>
<span class="sd">    constraint validation, and explicit sampling order control. It composes</span>
<span class="sd">    multiple spaces into a hierarchical structure where dependencies between</span>
<span class="sd">    variables can be handled through ordered sampling.</span>

<span class="sd">    Args:</span>
<span class="sd">        *args: Positional arguments passed to gymnasium.spaces.Dict.</span>
<span class="sd">        init_value (dict, optional): Initial values for the space. If None,</span>
<span class="sd">            derived from init_value of contained spaces.</span>
<span class="sd">        constrain_fn (callable, optional): Function that returns True if the</span>
<span class="sd">            complete dictionary satisfies custom constraints.</span>
<span class="sd">        sampling_order (list, optional): Explicit order for sampling keys.</span>
<span class="sd">            If None, uses insertion order. Missing keys are appended.</span>
<span class="sd">        **kwargs: Additional keyword arguments passed to Dict.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        init_value (dict): Initial values for all contained spaces.</span>
<span class="sd">        value (dict): Current values of all contained spaces.</span>
<span class="sd">        constrain_fn (callable): Constraint validation function.</span>
<span class="sd">        sampling_order (set): Set of dotted paths for all variables in order.</span>

<span class="sd">    Example:</span>
<span class="sd">        Create a nested space with sampling order dependencies::</span>

<span class="sd">            from stable_worldmodel import spaces</span>
<span class="sd">            import numpy as np</span>

<span class="sd">            config = spaces.Dict(</span>
<span class="sd">                {</span>
<span class="sd">                    &quot;difficulty&quot;: spaces.Discrete(n=3, init_value=0),</span>
<span class="sd">                    &quot;world&quot;: spaces.Dict(</span>
<span class="sd">                        {</span>
<span class="sd">                            &quot;width&quot;: spaces.Discrete(n=100, init_value=50),</span>
<span class="sd">                            &quot;height&quot;: spaces.Discrete(n=100, init_value=50),</span>
<span class="sd">                        }</span>
<span class="sd">                    ),</span>
<span class="sd">                    &quot;player_pos&quot;: spaces.Box(</span>
<span class="sd">                        low=np.array([0, 0]),</span>
<span class="sd">                        high=np.array([99, 99]),</span>
<span class="sd">                        init_value=np.array([25, 25]),</span>
<span class="sd">                    ),</span>
<span class="sd">                },</span>
<span class="sd">                sampling_order=[&quot;difficulty&quot;, &quot;world&quot;, &quot;player_pos&quot;],</span>
<span class="sd">            )</span>

<span class="sd">            # Sample respects order</span>
<span class="sd">            state = config.sample()</span>

<span class="sd">    Note:</span>
<span class="sd">        Sampling order is crucial when variables have dependencies. For</span>
<span class="sd">        example, sample world size before sampling positions within it.</span>
<span class="sd">        Nested Dict spaces recursively apply their own sampling orders.</span>

<span class="sd">        **Accessing values in constraint functions**: When implementing</span>
<span class="sd">        ``constrain_fn`` for Dict spaces, always use ``self.value[&#39;key&#39;][&#39;key2&#39;]``</span>
<span class="sd">        instead of ``self[&#39;key&#39;][&#39;key2&#39;].value``. The ``.value`` property</span>
<span class="sd">        recursively builds the complete value dictionary from the top level down,</span>
<span class="sd">        ensuring all nested values are up-to-date and correctly structured. Direct</span>
<span class="sd">        subspace access with ``.value`` only retrieves that specific subspace&#39;s</span>
<span class="sd">        value without the full context.</span>

<span class="sd">        Note that direct subspace access (e.g., ``self[&#39;key&#39;].value``) is perfectly</span>
<span class="sd">        fine for regular operations outside of constraint functions, such as reading</span>
<span class="sd">        individual subspace values or debugging. The recommendation to use top-level</span>
<span class="sd">        ``.value`` applies specifically to constraint functions where you need the</span>
<span class="sd">        complete, consistent state of all nested spaces.</span>

<span class="sd">        Example of proper constraint function usage::</span>

<span class="sd">            # Example: In a class with Dict space attribute</span>
<span class="sd">            class Environment:</span>
<span class="sd">                def __init__(self):</span>
<span class="sd">                    self.config_space = spaces.Dict({...})</span>

<span class="sd">                def validate_config(self):</span>
<span class="sd">                    # ✓ CORRECT: Access via .value at top level</span>
<span class="sd">                    values = self.config_space.value</span>
<span class="sd">                    return values[&quot;player_pos&quot;][0] &lt; values[&quot;world&quot;][&quot;width&quot;]</span>

<span class="sd">                def validate_wrong(self):</span>
<span class="sd">                    # ✗ AVOID: Direct subspace access</span>
<span class="sd">                    return (</span>
<span class="sd">                        self.config_space[&quot;player_pos&quot;].value[0]</span>
<span class="sd">                        &lt; self.config_space[&quot;world&quot;][&quot;width&quot;].value</span>
<span class="sd">                    )</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Dict.__init__">
<a class="viewcode-back" href="../../stable_worldmodel.html#stable_worldmodel.spaces.Dict.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">init_value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">constrain_fn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sampling_order</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize a Dict space with state tracking and sampling order.</span>

<span class="sd">        Args:</span>
<span class="sd">            *args: Positional arguments passed to gymnasium.spaces.Dict.</span>
<span class="sd">            init_value (dict, optional): Initial values for the space. If None,</span>
<span class="sd">                derived from init_value of contained spaces. Defaults to None.</span>
<span class="sd">            constrain_fn (callable, optional): Function that takes a dict and</span>
<span class="sd">                returns True if the complete dictionary satisfies custom constraints.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            sampling_order (list, optional): Explicit order for sampling keys.</span>
<span class="sd">                If None, uses insertion order. Missing keys are appended with warning.</span>
<span class="sd">                Defaults to None.</span>
<span class="sd">            **kwargs: Keyword arguments passed to gymnasium.spaces.Dict.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If sampling_order contains keys not present in spaces.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constrain_fn</span> <span class="o">=</span> <span class="n">constrain_fn</span> <span class="ow">or</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_value</span> <span class="o">=</span> <span class="n">init_value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_value</span>

        <span class="c1"># add missing keys</span>
        <span class="k">if</span> <span class="n">sampling_order</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sampling_order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spaces</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">sampling_order</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spaces</span><span class="p">):</span>
            <span class="n">missing_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spaces</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">sampling_order</span><span class="p">))</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Dict sampling_order is missing keys </span><span class="si">{</span><span class="n">missing_keys</span><span class="si">}</span><span class="s2">, adding them at the end of the sampling order&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sampling_order</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sampling_order</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">missing_keys</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_sampling_order</span> <span class="o">=</span> <span class="n">sampling_order</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spaces</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sampling_order</span><span class="p">):</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sampling_order</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spaces</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sampling_order contains keys not in spaces: </span><span class="si">{</span><span class="n">missing</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">init_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;dict: Initial values for all contained spaces.</span>

<span class="sd">        Constructs initial value dictionary from contained spaces&#39; init_value</span>
<span class="sd">        properties. Falls back to sampling if a space lacks init_value.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Dictionary mapping space keys to their initial values.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">init_val</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spaces</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s2">&quot;init_value&quot;</span><span class="p">):</span>
                <span class="n">init_val</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">init_value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Space </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s2"> does not have init_value property, using default sample instead&quot;</span>
                <span class="p">)</span>
                <span class="n">init_val</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">init_val</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;dict: Current values of all contained spaces.</span>

<span class="sd">        Constructs value dictionary from contained spaces&#39; value properties.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: Dictionary mapping space keys to their current values.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If a contained space does not have a value property.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">val</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spaces</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">):</span>
                <span class="n">val</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">value</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Space </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> of type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s2"> does not have value property&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">val</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_get_sampling_order</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parts</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Yield dotted paths for nested Dict space respecting sampling order.</span>

<span class="sd">        Recursively generates dotted-path strings for all variables in this</span>
<span class="sd">        Dict space and any nested Dict spaces, honoring the explicit</span>
<span class="sd">        sampling order when available.</span>

<span class="sd">        Args:</span>
<span class="sd">            parts (tuple, optional): Parent path components for recursion.</span>
<span class="sd">                Defaults to empty tuple.</span>

<span class="sd">        Yields:</span>
<span class="sd">            str: Dotted path strings like &#39;parent.child.key&#39; for each variable.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">parts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="p">()</span>

        <span class="c1"># Prefer an explicit sampling order; otherwise preserve insertion order.</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;_sampling_order&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">spaces</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="c1"># Skip if the key isn&#39;t in the mapping (defensive against stale order lists).</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spaces</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="n">key_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>  <span class="c1"># ensure joinable</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">parts</span> <span class="o">+</span> <span class="p">(</span><span class="n">key_str</span><span class="p">,)</span>
            <span class="k">yield</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

            <span class="n">subspace</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spaces</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subspace</span><span class="p">,</span> <span class="n">spaces</span><span class="o">.</span><span class="n">Dict</span><span class="p">):</span>
                <span class="c1"># Recurse into nested Dict spaces</span>
                <span class="k">yield from</span> <span class="n">subspace</span><span class="o">.</span><span class="n">_get_sampling_order</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">sampling_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;set: Set of dotted paths for all variables in sampling order.</span>

<span class="sd">        Returns:</span>
<span class="sd">            set: Set of strings representing dotted paths (e.g., &#39;parent.child.key&#39;)</span>
<span class="sd">                for all variables including nested Dict spaces.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_sampling_order</span><span class="p">())</span>

<div class="viewcode-block" id="Dict.reset">
<a class="viewcode-back" href="../../stable_worldmodel.html#stable_worldmodel.spaces.Dict.reset">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Reset all contained spaces to their initial values.</span>

<span class="sd">        Calls reset() on all contained spaces that have a reset method,</span>
<span class="sd">        then sets this space&#39;s value to init_value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spaces</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s2">&quot;reset&quot;</span><span class="p">):</span>
                <span class="n">v</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_value</span></div>


<div class="viewcode-block" id="Dict.contains">
<a class="viewcode-back" href="../../stable_worldmodel.html#stable_worldmodel.spaces.Dict.contains">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">contains</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if value is a valid member of this space.</span>

<span class="sd">        Validates that x is a dictionary containing all required keys with</span>
<span class="sd">        values that satisfy each subspace&#39;s constraints and the overall</span>
<span class="sd">        constraint function.</span>

<span class="sd">        Args:</span>
<span class="sd">            x: The value to check.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if x is a valid dict with all keys present, all values</span>
<span class="sd">                within subspace bounds, and satisfies the constraint function.</span>
<span class="sd">                False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spaces</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">spaces</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">constrain_fn</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="Dict.check">
<a class="viewcode-back" href="../../stable_worldmodel.html#stable_worldmodel.spaces.Dict.check">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate all contained spaces&#39; current values.</span>

<span class="sd">        Checks each contained space using its check() method if available,</span>
<span class="sd">        or falls back to contains(value). Optionally logs warnings for</span>
<span class="sd">        failed checks.</span>

<span class="sd">        Args:</span>
<span class="sd">            debug (bool, optional): If True, logs warnings for spaces that</span>
<span class="sd">                fail validation. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            bool: True if all contained spaces have valid values, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">spaces</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s2">&quot;check&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">v</span><span class="o">.</span><span class="n">check</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">debug</span><span class="p">:</span>
                        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Dict: space </span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2"> failed check()&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="Dict.names">
<a class="viewcode-back" href="../../stable_worldmodel.html#stable_worldmodel.spaces.Dict.names">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return all space keys including nested ones.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list: A list of all keys in the Dict space, with nested keys using dot notation.</span>
<span class="sd">                For example, a nested dict with key &quot;a&quot; containing subspace &quot;b&quot; would produce &quot;a.b&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_key_generator</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">parent_key</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">new_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">parent_key</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">parent_key</span> <span class="k">else</span> <span class="n">k</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">spaces</span><span class="o">.</span><span class="n">Dict</span><span class="p">):</span>
                    <span class="k">yield from</span> <span class="n">_key_generator</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">spaces</span><span class="p">,</span> <span class="n">new_key</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">new_key</span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">_key_generator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spaces</span><span class="p">))</span></div>


<div class="viewcode-block" id="Dict.sample">
<a class="viewcode-back" href="../../stable_worldmodel.html#stable_worldmodel.spaces.Dict.sample">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">sample</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">max_tries</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">warn_after_s</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">set_value</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sample a random element from the Dict space.</span>

<span class="sd">        Samples each subspace in the sampling order and ensures the result satisfies</span>
<span class="sd">        any constraint functions. Uses rejection sampling if constraints are present.</span>

<span class="sd">        Args:</span>
<span class="sd">            *args: Positional arguments passed to each subspace&#39;s sample method.</span>
<span class="sd">            max_tries (int, optional): Maximum number of rejection sampling attempts.</span>
<span class="sd">                Defaults to 1000.</span>
<span class="sd">            warn_after_s (float, optional): Issue a warning if sampling takes longer than</span>
<span class="sd">                this many seconds. Set to None to disable warnings. Defaults to 5.0.</span>
<span class="sd">            set_value (bool, optional): Whether to set the internal value to the sampled value.</span>
<span class="sd">                Defaults to True.</span>
<span class="sd">            **kwargs: Additional keyword arguments passed to each subspace&#39;s sample method.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict: A dictionary with keys matching the space definition and values sampled</span>
<span class="sd">                from their respective subspaces.</span>

<span class="sd">        Raises:</span>
<span class="sd">            RuntimeError: If a valid sample is not found within max_tries attempts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_tries</span><span class="p">):</span>
            <span class="n">sample</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sampling_order</span><span class="p">:</span>
                <span class="n">sample</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spaces</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">set_value</span><span class="o">=</span><span class="n">set_value</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">sample</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">set_value</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">sample</span>
                <span class="k">return</span> <span class="n">sample</span>

            <span class="k">if</span> <span class="n">warn_after_s</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">warn_after_s</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;rejection sampling is taking a while...&quot;</span><span class="p">)</span>

        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;constrain_fn not satisfied after </span><span class="si">{</span><span class="n">max_tries</span><span class="si">}</span><span class="s2"> draws&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Dict.update">
<a class="viewcode-back" href="../../stable_worldmodel.html#stable_worldmodel.spaces.Dict.update">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keys</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update specific keys in the Dict space by resampling them.</span>

<span class="sd">        Samples new values for the specified keys while maintaining the sampling order.</span>
<span class="sd">        Uses dot notation for nested keys (e.g., &quot;a.b&quot; for nested dict).</span>

<span class="sd">        Args:</span>
<span class="sd">            keys (container): A container (list, set, etc.) of key names to resample.</span>
<span class="sd">                Keys should use dot notation for nested spaces.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If a specified key is not found in the Dict space.</span>
<span class="sd">            AssertionError: If the updated values violate the space constraints.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
        <span class="n">order</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampling_order</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s2">&quot;all&quot;</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">filter</span><span class="p">(</span><span class="n">keys</span><span class="o">.</span><span class="fm">__contains__</span><span class="p">,</span> <span class="n">order</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">var_path</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
                    <span class="n">swm</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">get_in</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">var_path</span><span class="p">)</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>

                <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Key </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2"> not found in Dict space&quot;</span><span class="p">)</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">check</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="s2">&quot;Values must be within space!&quot;</span></div>
</div>

</pre></div>
        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link fa-brands fa-solid fa-discord" href="https://discord.gg/8M6hT39X" aria-label="Discord"></a>
              <a class="muted-link fa-brands fa-solid fa-github" href="https://github.com/randall-lab/stable-worldmodel" aria-label="GitHub"></a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer no-toc">
      
      
      
    </aside>
  </div>
</div><script src="../../_static/documentation_options.js?v=a5192d03"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=46bd48cc"></script>
    </body>
</html>